---
authors: "T1 - Phoenix"
title: "Spotify Tracks Popularity Prediction"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries Used, warning=FALSE, include=FALSE}
library(tidyverse)
library(dplyr)
library(corrplot)
library(mapview)
library(tigris)
library(sf)
library(ggplot2)
library(lubridate)
library(ezids)
library(gridExtra)
library(grid)
library(lattice)
library(caret)
```

Let us pull the dataset from the file `spotify_dataset.csv` into a dataframe `df_spotify`. As this file is huge in size, we cannot upload it on GitHub. Thus, we are storing the file in a folder called `spotify_dataset` that is located in one folder above the project folder.

```{r Pulling the Data}
df_spotify <- data.frame(read.csv('spotify_dataset.csv'))
str(df_spotify)
```

```{r}
head(df_spotify)
tail(df_spotify)
```

```{r}
summary(df_spotify)
```

First, let's check the percentage of NA's present in each columns of the dataset.

```{r Checking NAs}
(colMeans(is.na(df_spotify)))*100
```

```{r}
data_corr<-df_spotify %>% select_if(is.numeric)   
data_corr = subset(data_corr, select = -c(X) )
corrplot.mixed(cor(data_corr))
```


```{r Popularity Distribution Graph}
ggplot(df_spotify, aes(x = popularity, fill=popularity)) +
    geom_bar()
```


```{r Danceability Distribution Graph}
ggplot(df_spotify, aes(x = danceability, fill=danceability)) +
    geom_bar()
```

```{r}
acHist <- ggplot(df_spotify, aes(x=acousticness)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of Acousticness")
acHist

```

```{r}
# scatter plot for acousticness & popularity
acSctr<- ggplot(df_spotify, aes(x=popularity, y= acousticness)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for Acousticness")
acSctr
```

```{r}
# thought this violin plot will be better with other variables in violin plots
acV <- ggplot(df_spotify, aes(x=acousticness, y=popularity,fill="#69b3a2")) + 
  geom_violin() +
  ggtitle("Violinplot for Acousticness")
acV
```


```{r, results='hide'}
# made basic histogram & scatterplot for every other variables that we didn't include to our SMART Q
speechinessHist <- ggplot(df_spotify, aes(x=speechiness)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of speechiness")
speechinessHist

speechinessSct<- ggplot(df_spotify, aes(x=popularity, y= speechiness)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for speechiness")
speechinessSct

instrumentalnessHist <- ggplot(df_spotify, aes(x=instrumentalness)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of instrumentalness")
instrumentalnessHist

instrumentalnessSctr<- ggplot(df_spotify, aes(x=popularity, y= instrumentalness)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for instrumentalness")
instrumentalnessSctr

livenessHist <- ggplot(df_spotify, aes(x=liveness)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of liveness")
livenessHist

livenessSct<- ggplot(df_spotify, aes(x=popularity, y= liveness)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for liveness")
livenessSct

valenceHist <- ggplot(df_spotify, aes(x=valence)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of instrumentalness")
valenceHist

valenceSctr<- ggplot(df_spotify, aes(x=popularity, y= valence)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for valence")
valenceSctr

tempoHist <- ggplot(df_spotify, aes(x=tempo)) + geom_histogram(fill="#69b3a2", alpha=0.9, bins = 75)+
  ggtitle("Histogram of tempo")
tempoHist

tempoSctr<- ggplot(df_spotify, aes(x=popularity, y= tempo)) +
  geom_point(size = 0.1) +
  ggtitle("Scatterplot for tempo")
tempoSctr
```

```{r}
histfig <- ggarrange(acHist, speechinessHist, instrumentalnessHist,livenessHist, valenceHist,tempoHist, ncol = 3, nrow = 2)
histfig

sctfig <- ggarrange(acSctr, speechinessSct, instrumentalnessSctr,livenessSct, valenceSctr,tempoSctr, ncol = 3, nrow = 2)
sctfig
```


#DATA Preprocessing
```{r}
options(dplyr.summarise.inform = FALSE)
missing.values <- df_spotify %>%
    gather(key = "key", value = "val") %>%
    mutate(is.missing = is.na(val)) %>%
    group_by(key, is.missing) %>%
    summarise(num.missing = n()) %>%
    filter(is.missing==T) %>%
    select(-is.missing) %>%
    arrange(desc(num.missing)) 

```

```{r}
missing.values
```

```{r}
df_spotify<-df_spotify %>%
 mutate(duration_min = duration_ms/60000)

```

```{r}
df_spotify$duration_min <- round(df_spotify$duration_min ,digit=2)
head(df_spotify)
```

```{r}
df_spotify$artists[df_spotify$artists == '['] <- ''
df_spotify$artists[df_spotify$artists == ']']<- ''
df_spotify$artists[df_spotify$artists == "'"]<- ''
head(df_spotify)
```

# removing columns track_id and X as they are not required.

```{r}
data_corr = subset(df_spotify, select = -c(track_id,X) )
```


```{r}
data_corr<-data_corr[!duplicated(data_corr),]
```

```{r}
data_corr = subset(data_corr, select = -c(duration_ms) )
```



```{r}
valence <- ggplot(data_corr, aes(x=valence)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

tempo <- ggplot(data_corr, aes(x=tempo)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

acousticness <- ggplot(data_corr, aes(x=acousticness)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

danceability <- ggplot(data_corr, aes(x=danceability)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

speechiness <- ggplot(data_corr, aes(x=speechiness)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

mode <- ggplot(data_corr, aes(x=mode)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

liveness <- ggplot(data_corr, aes(x=liveness)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

loudness <- ggplot(data_corr, aes(x=loudness)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

popularity <- ggplot(data_corr, aes(x=popularity)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

energy <- ggplot(data_corr, aes(x=energy)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")


key <- ggplot(data_corr, aes(x=key)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")

```


```{r}
library(ggpubr)
figure <- ggarrange(valence, tempo, acousticness,speechiness, danceability,mode,liveness,loudness,popularity,energy, key, ncol = 3, nrow = 5)
figure
```

```{r}

data_corr<-df_spotify %>% select_if(is.numeric)   
data_corr = subset(data_corr, select = -c(X) )
data_corr

corrplot(cor(data_corr))




```

#From the distribution plot, we can observe that, columns such as energy, and valence has high variability where as liveness, danceability, tempo and loudness has relatively lower variability and concentrated in some ranges.


```{r}
ggplot(data_corr, aes(x=energy, y=popularity)) + geom_point(col = "deeppink1") 
```

```{r}
ggplot(data_corr, aes(x=acousticness, y=popularity)) + geom_point(col = "deeppink1") 
```

```{r}

ggplot(data_corr, aes(x=loudness, y=popularity)) + geom_point(col = "deeppink1") 
```

```{r}
test_energy <- chisq.test(table(df_spotify$popularity, df_spotify$energy))
test_energy

test_loudness <- chisq.test(table(df_spotify$popularity, df_spotify$loudness))
test_loudness

test_acoustic <- chisq.test(table(df_spotify$popularity, df_spotify$acousticness))
test_acoustic


```

```{r}

cor(df_spotify$popularity, df_spotify$energy)

cor(df_spotify$popularity, df_spotify$loudness)

cor(df_spotify$popularity, df_spotify$acousticness)


```

```{r}
energy_anova = aov(energy~popularity, data=df_spotify)
summary(energy_anova)

loudness_anova = aov(loudness~popularity, data=df_spotify)
summary(loudness_anova)

acoustic_anova = aov(acousticness~popularity, data=df_spotify)
summary(acoustic_anova)
```

# Data 

```{r}
set.seed(123)
dat.d <- sample(1:nrow(data_corr),size=nrow(data_corr)*0.8,replace = FALSE) #random selection of 70% data.

data_corr.a = subset(data_corr, select = c(popularity_t,acousticness,danceability,duration_ms,energy,instrumentalness,key
                                           ,liveness,mode,speechiness,tempo,time_signature,valence) )
 
train <- data_corr.a[dat.d,] # 80% training data
test <- data_corr.a[-dat.d,] # remaining 20% test data
```


```{r}
prc_train_labels <- train[,1]
prc_test_labels <- test[,1]

```

```{r}
library(class)
```


```{r}
prc_test_pred <- knn(train = train, test = test,cl = prc_train_labels, k=3)

```

```{r}
acc <- 100 * sum(prc_test_labels == prc_test_pred)/NROW(prc_test_labels)
acc

```

```{r}
data_corr <- data_corr %>% mutate(popularity_t = if_else(popularity > 50, 1, 0))
data_corr
```


```{r t test on popularity_t with numeric variables}
pop1 <- subset(data_corr, popularity_t == 1)
pop2 <- subset(data_corr, popularity_t == 0)
str(pop1)
str(pop2)

ttest_dance <- t.test(pop1$danceability, pop2$danceability)
ttest_dance
ttest_energy <- t.test(pop1$energy, pop2$energy)
ttest_energy
ttest_loudness <- t.test(pop1$loudness, pop2$loudness)
ttest_loudness
ttest_speechiness <- t.test(pop1$speechiness, pop2$speechiness)
ttest_speechiness
ttest_acousticness <- t.test(pop1$acousticness, pop2$acousticness)
ttest_acousticness
ttest_instrumentalness <- t.test(pop1$instrumentalness, pop2$instrumentalness)
ttest_instrumentalness
ttest_liveness <- t.test(pop1$liveness, pop2$liveness)
ttest_liveness
ttest_valence <- t.test(pop1$valence, pop2$valence)
ttest_valence
ttest_tempo <- t.test(pop1$tempo, pop2$tempo)
ttest_tempo
ttest_duration_min <- t.test(pop1$duration_min, pop2$duration_min)
ttest_duration_min

```
```{r chisq on pop_t and categorical}

chi_key <- chisq.test(table(data_corr$popularity_t, data_corr$key))
chi_key
chi_mode <- chisq.test(table(data_corr$popularity_t, data_corr$mode))
chi_mode
chi_time_signature <- chisq.test(table(data_corr$popularity_t, data_corr$time_signature))
chi_time_signature

```{r}
plot(density(test$popularity - pop_pred),col = 'red',
    xlab = 'Residual',
    ylab = 'Density',
    main = 'Density Plot of Residual')
```

```{r}
plot(test$popularity,type='l',col='green',main = 'Line plot of Prediction and Test',
    xlab = 'Index',ylab = 'popularity')
lines(pop_pred,type = 'l',col='red')

legend(80, 25000, legend=c("True", "Pred."),
       col=c("red", "green"), lty=1:1, cex=1.6,box.lty = 0)
```
```{r}
set.seed(123)
dat.d <- sample(1:nrow(data_corr),size=nrow(data_corr)*0.8,replace = FALSE) #random selection of 70% data.
 
train <- data_corr.a[dat.d,] # 80% training data
test <- data_corr.a[-dat.d,] # remaining 20% test data
```


```{r}
prc_train_labels <- train[,1]
prc_test_labels <- test[,1]

```

```{r}
library(class)
```


```{r}
prc_test_pred <- knn(train = train, test = test,cl = prc_train_labels, k=3)

```

```{r}
acc <- 100 * sum(prc_test_labels == prc_test_pred)/NROW(prc_test_labels)
acc

```

```{r}
data_corr <- data_corr %>% mutate(popularity_t = if_else(popularity > 56, 1, 0))
data_corr
```
```{r t test on popularity_t with numeric variables}
pop1 <- subset(data_corr, popularity_t == 1)
pop2 <- subset(data_corr, popularity_t == 0)
str(pop1)
str(pop2)

ttest_dance <- t.test(pop1$danceability, pop2$danceability)
ttest_dance
ttest_energy <- t.test(pop1$energy, pop2$energy)
ttest_energy
ttest_loudness <- t.test(pop1$loudness, pop2$loudness)
ttest_loudness
ttest_speechiness <- t.test(pop1$speechiness, pop2$speechiness)
ttest_speechiness
ttest_acousticness <- t.test(pop1$acousticness, pop2$acousticness)
ttest_acousticness
ttest_instrumentalness <- t.test(pop1$instrumentalness, pop2$instrumentalness)
ttest_instrumentalness
ttest_liveness <- t.test(pop1$liveness, pop2$liveness)
ttest_liveness
ttest_valence <- t.test(pop1$valence, pop2$valence)
ttest_valence
ttest_tempo <- t.test(pop1$tempo, pop2$tempo)
ttest_tempo
ttest_duration_min <- t.test(pop1$duration_min, pop2$duration_min)
ttest_duration_min

```

```{r chisq on pop_t and categorical}

chi_key <- chisq.test(table(data_corr$popularity_t, data_corr$key))
chi_key
chi_mode <- chisq.test(table(data_corr$popularity_t, data_corr$mode))
chi_mode
chi_time_signature <- chisq.test(table(data_corr$popularity_t, data_corr$time_signature))
chi_time_signature
```

```{r t test and ANOVA on popularity by categorical variables}
unique(pop1$key)
unique(pop1$mode)
unique(pop1$time_signature)
mode1 <- subset(data_corr, mode == 1)
mode0 <- subset(data_corr, mode == 0)
str(mode1)
str(mode0)

ttest_mode <- t.test(mode1$popularity, mode0$popularity)
ttest_mode

aovtime_signature <- aov(popularity ~ time_signature, data = data_corr)
summary(aovtime_signature)

```


```{r}
library(rpart)
library(rpart.plot)

fit <- rpart(popularity_t~., data = train, method = 'class')
```

```{r}
summary(fit)
```

```{r}
predict_unseen <-predict(fit, test, type = 'class')
```


```{r}
table_mat <- table(test$popularity_t, predict_unseen)
table_mat
```

```{r}
accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
print(paste('Accuracy for test', accuracy_Test))

```

```{r}
library(randomForest)

iris.rf <- randomForest(popularity_t~., 
                        data = train, 
                        importance = TRUE,
                        proximity = TRUE)
```

```{r}
head(data_corr)
```


```{r}
model = glm(popularity_t~.,data=train )

Predicr_value = predict(model,test)                          #predict test value purchased

predict_test_value = ifelse((Predicr_value>0.5),1,0)

                           #See predict value and actual
Compare_values = cbind(predict_test_value,test[,1])
Compare_values
```

```{r}
Compare_values = data.frame(Compare_values)
head(Compare_values)
class(Compare_values)
caret::confusionMatrix(as.factor(Compare_values[,1]),as.factor(Compare_values[,2]))
```

