---
authors: 
title: "us_accidents_traffic"
output: html_document
date: "2022-10-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries Used}
library(tidyverse)
library(dplyr)
library(corrplot)
library(mapview)
library(tigris)
library(sf)
library(ggplot2)
library(lubridate)
library(ezids)
library(gridExtra)
library(grid)
library(lattice)
```

```{r intro}
df_us_acc <- data.frame(read.csv('../us_accidents_dataset/US_Accidents_Dec21_updated.csv'))
str(df_us_acc)
```

```{r}
(colMeans(is.na(df_us_acc)))*100
```


```{r}
df_us_acc$year<-format(as.Date(df_us_acc$Start_Time, format="%Y-%m-%d"),"%Y")
head(df_us_acc)
```

```{r}
ggplot(df_us_acc, aes(x = year, fill=year)) +
    geom_bar()
```


```{r}
accidents_2021 <- subset(df_us_acc, year==2021)
head(accidents_2021)
```

```{r}
accidents_2021$month<-format(as.Date(accidents_2021$Start_Time, format="%Y-%m-%d"),"%m")
head(accidents_2021)
```

```{r}
accidents_2021<-subset(accidents_2021, select = -c(Number, ID, Description))
```

```{r}
(colMeans(is.na(accidents_2021)))*100
```

```{r}
accidents_2021 <- accidents_2021 %>% 
  mutate(Is_severe = if_else(Severity == 1 | Severity ==2 , "Not Severe", "Severe"))
```

```{r}
accidents_2021  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```



```{r Drop NA, Factorize severity}
clean_acc21 <- drop_na(accidents_2021)

```

```{r}
clean_acc21$Is_severe <- as.factor(clean_acc21$Is_severe) # make Is_severe as factor
str(clean_acc21)
```

```{r}
clean_acc21  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```

```{r}
us_date<-clean_acc21$Start_Time 
us_date_formatted<- as.Date(us_date,format="%Y-%m-%d")
clean_acc21$Month<-as.numeric(format(us_date_formatted, "%m"))
```

```{r}
us_time<- clean_acc21$Start_Time
clean_acc21$Hour<-hour(us_time)
```

```{r}
ggplot(clean_acc21, aes(x = month, fill=month,)) +geom_bar()+labs(title="Accident Distribution over the Months in 2021", x="Months", y = "count")+
  theme(plot.title = element_text(hjust = 0.5))
ggplot(clean_acc21, aes(x = Hour, fill=as.factor(Hour))) + geom_bar()+
  labs(title="Accident Distribution in Hours ", x="Hours", y = "count")+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
hist(clean_acc21$Hour,main="Histogram for Hours",xlab = "Hours")
```

```{r}
df_map<-dplyr::select(clean_acc21, State, Start_Lat, Start_Lng)
head(df_map)
```

```{r}
df_map_DC <- df_map %>% filter(State == "DC")

df_map_DC %>% glimpse()
```

```{r}
df_map_DC_sf <- st_as_sf(df_map_DC, coords = c("Start_Lng", "Start_Lat"), crs = 4326)
```

```{r}
mapview(df_map_DC_sf, main="Map for Accidents in DC(2021)" ,xcol = "Start_Lng", ycol = "Start_Lat", grid = FALSE,col.regions=("red"))
```

```{r}
mapview(df_map_DC_sf, map.types = "Stamen.Toner",col.regions=("red"))
```

```{r Correlations for numerical values}
# subsetting numerical columns only to check the corelationship between numerical weather variables
loadPkg("corrplot")
num_clean_acc21 <- select_if(clean_acc21, is.numeric)
num_weather <- subset(num_clean_acc21, select = -c(Start_Lat,Start_Lng,End_Lat,End_Lng,Distance.mi.))
corrplot(cor(num_weather), method = "number")
```

We subsetted the numerical columns only to check the corelationship between numerical weather variables and the severity of traffic.
As we can see from the plot, there is no strong corelationship between numerical weather variables and the severity of traffic. (*SHOUD I REMOVE THIS?)


```{r Histograms for Weather Conditions}

tempHist <- ggplot(clean_acc21, aes(x=Temperature.F.)) + geom_histogram(color="black", fill = "red")+
  ggtitle("Histogram of Temperature(F) for accidents")
tempHist

windcHist <- ggplot(clean_acc21, aes(x=Wind_Chill.F.)) + geom_histogram(color="black", fill = "orange")+
  ggtitle("Histogram of Wind chill for accidents")
windcHist

humidHist <- ggplot(clean_acc21, aes(x=Humidity...)) + geom_histogram(color="black", fill = "yellow")+
  ggtitle("Histogram of Humidity for accidents")
humidHist

windsHist <- ggplot(clean_acc21, aes(x=Wind_Speed.mph.)) + geom_histogram(color="black", fill = "navy")+
  ggtitle("Histogram of Wind Speed for accidents")
windsHist

pressHist <- ggplot(clean_acc21, aes(x=Pressure.in.)) + geom_histogram(color="black", fill = "green")+
  ggtitle("Histogram of Pressure for accidents")
pressHist

visibHist <- ggplot(clean_acc21, aes(x=Visibility.mi.)) + geom_histogram(color="black", fill = "blue")+
  ggtitle("Histogram of Visibility for accidents")
visibHist

precipHist <- ggplot(clean_acc21, aes(x=Precipitation.in.)) + geom_histogram(color="black", fill = "purple")+
  ggtitle("Histogram of Precipitation for accidents")
precipHist

```

To answer the first SMART question we have, which is "Does weather affect the severity of traffic?", we wanted to check the distribution of data for numerical weather variables first.
We created histograms between numbers of accidents and weather condition elements.
From those histograms, we found that Temperature, Wind chill, and Humidity have left-skewed distributions.  
For the rest of element, which are Wind Speed, Pressure, Visibility, and Precipitation, they have quite close mean and median with a few outliers.  

```{r}
wooutlier_winds <- outlierKD2(clean_acc21, Wind_Speed.mph., rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)
clean_acc21_woo <- outlierKD2(wooutlier_winds, Pressure.in., rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)
#wooutlier_windsPressVi <- outlierKD2(wooutlier_windsPress, Visibility.mi., rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)
#clean_acc21_woo <- outlierKD2(wooutlier_windsPressVi, Precipitation.in., rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE) 
# I failed to remove outliers from Wind Pressure, Visibility, and Precipitation
```
So we tried to remove the outliers from Wind Speed and Pressure and without outliers, and from the generated plots we can see they are more normally distributed than the original data.
But we decided to keep the outliers because it is natural to have outliers in the weather variables as the data covers a whole year. Also the outliers does not affect the result of T-test.

```{r boxplots between Severity and wind conditions elements }

ggplot(clean_acc21, aes(x = Is_severe, y=Temperature.F.)) + 
  geom_boxplot() +
  labs(title="Temperature by Severity", x="Severity", y = "Temperature(F)")

ggplot(clean_acc21, aes(x = Is_severe, y=Wind_Chill.F.)) + 
  geom_boxplot() +
  labs(title="Wind Chill by Severity", x="Severity", y = "Wind Chill")

ggplot(clean_acc21, aes(x = Is_severe, y=Wind_Speed.mph.)) + 
  geom_boxplot() +
  labs(title="Wind Speed by Severity", x="Severity", y = "Wind Speed")

ggplot(clean_acc21, aes(x = Is_severe, y=Humidity...)) + 
  geom_boxplot() +
  labs(title="Humidity by Severity", x="Severity", y = "Humidity")

ggplot(clean_acc21, aes(x = Is_severe, y=Pressure.in.)) + 
  geom_boxplot() +
  labs(title="Pressure by Severity", x="Severity", y = "Pressure")

ggplot(clean_acc21, aes(x = Is_severe, y=Visibility.mi.)) + 
  geom_boxplot() +
  labs(title="Visibility by Severity", x="Severity", y = "Visibility")

ggplot(clean_acc21, aes(x = Is_severe, y=Precipitation.in.)) + 
  geom_boxplot() +
  labs(title="Precipitation by Severity", x="Severity", y = "Precipitation")

## The same variables(Temp, wind chill, humidity) have pretty plots
```
We tried to see the distribution of weather elements by two different severity levels which are 'Severe' and 'Not Severe'. 

For Temperature, Wind chill, and Humanity, we can see the difference on range of data distribution and outliers by severity levels.

For the rest of element such as wind speed, pressure, visibility and precipitation, they still do not have a wide range of data but we can see the distribution by two severity levels more conveniently with boxplots.

```{r T-test on Severity and weather condition elements}
box_clean2_severe = subset(clean_acc21, Is_severe == 'Severe')
box_clean2_notsevere = subset(clean_acc21, Is_severe == 'Not Severe')
print("Temperature.F")
t.test(box_clean2_severe$Temperature.F., box_clean2_notsevere$Temperature.F.)
print("Wind_Chill.F.")
t.test(box_clean2_severe$Wind_Chill.F., box_clean2_notsevere$Wind_Chill.F.)
print("Humidity...")
t.test(box_clean2_severe$Humidity..., box_clean2_notsevere$Humidity...)
print("Wind_Speed.mph.")
t.test(box_clean2_severe$Wind_Speed.mph., box_clean2_notsevere$Wind_Speed.mph.)
print("Visibility.mi.")
t.test(box_clean2_severe$Visibility.mi., box_clean2_notsevere$Visibility.mi.)
print("Pressure.in.")
t.test(box_clean2_severe$Pressure.in., box_clean2_notsevere$Pressure.in.)
print("Precipitation.in.")
t.test(box_clean2_severe$Precipitation.in., box_clean2_notsevere$Precipitation.in.)
```
We performed the two-sample t-test on Severity and weather elements. 

First, I divided the data into two different data by subsetting by the severity to check the means of Weather elements between two different severity levels will be same or not. 

H0: The means of Temperature/WindChill/Humidity/Wind Speed/Pressure/Visibility/Precipitation will be same between different Severity levels.
H1: The means of Temperature/WindChill/Humidity/Wind Speed/Pressure/Visibility/Precipitation will NOT be same between different Severity levels.

The p-value from all tests except for Visibility are lower than 0.05 so we can reject the H0 for every weather variables but Visibility, which means that means from weather variables except for Visibility were different by its severity level of traffic. 

From these t-tests, we can conclude that numerical weather variables such as Temperature, WindChill, Humidity, Pressure, Wind Speed and Precipitation affect the severity of traffic.

However, numerical weather variables are not only variables from weather conditions.
There are categorical weather variables in our dataset, such as Wind Directions and Weather Conditions. 
```{r Wind_Direction}
# wind direction with severity
ggplot(clean_acc21, aes(Wind_Direction, ..prop.., group = Is_severe)) +
  geom_bar(aes(fill = Is_severe)) +
  #scale_y_continuous(labels = percent) +
  labs(x = "Wind Direction",
       y = "Proportion",
       title = "Wind direction by Severity") +
  theme(text = element_text(size=8)) 
```
We made a bar plot to see the distribution of the Severity by wind directions.
As the bar plot between Severity and Wind direction here shows the similar distribution for each severity levels on most of wind direction. So we can infer that wind direction does not affect much on the severity of traffic and decided not to perform any statistical analysis on the Wind Direction variable.
```{r Weather_Condition variables}
# Weather Condition percentage
unique(clean_acc21$Weather_Condition)
WC <- clean_acc21 %>%
  group_by(Weather_Condition) %>%
  summarise(cnt = n()) %>%
  mutate(freq = (round(cnt/sum(cnt), 3))*100 )%>%
  arrange(desc(freq)) %>%
  filter(freq > 1)
WC
WC %>%
    ggplot() +
    geom_col(mapping = aes(x=reorder(Weather_Condition, -freq), y=freq, fill = Weather_Condition)) +
    labs(x = "Weather Condition", y="%", title ="Top 8 Weather Conditions with accidents") +
    theme(text = element_text(size=7))
```
Secondly, we took a look at the Weather Condition variable.  
There are so many weather conditions in our dataset, so I tried to make a barplot with the top 8 weather conditions when accidents happened. The major weather conditions when car accidents happened were 'Fair', 'Cloudy', 'Mostly Cloudy', 'Partly Cloudy', 'Light Rain', 'Fog', 'Light Snow', and 'Haze'.  

Now we can see that the most frequent weather was 'Fair', but since the Weather Conditions variable is divided into detailed conditions as you can see here with cloudy, mostly cloudy, and partly cloudy, so we decided to take a chi-squared test on all weather conditions and severity. 

```{r}
# Try the Chi-Squared Test on all Weather_Conditions and Severity
WCtable <- table(clean_acc21$Weather_Condition , clean_acc21$Severity)
xkabledply(WCtable, title = "Severity by Weather Conditions")
chitest = chisq.test(WCtable)
chitest
```
Took a Chi-Squared test to see the severity and weather conditions are independent.
H0 : Severity and weather conditions are independent.
H1 : Severity and weather conditions are NOT independent.  
As we can see here, the the P-value from Chi-squared test is lower than 0.05 for Weather Conditions variable so we can reject the H0. Which means the Severity of traffic and weather conditions are Dependent. 

From these analysis on numerical and categorical weather variables, we can answer our SMART question about the impact for weather on the severity of traffic.
We concluded that the numerical weather condition elements except for visibility affect the severity of traffic.
However, the wind direction does not affect much the severity of traffic because it does not show differences on severity by each of directions. 
For the weather conditions variables, we can observe that weather conditions at the time accidents happened affect the severity of traffic.


SMART QUESTION: 

Do Nearby Road Elements affect the severity of traffic?

To determine whether nearby road components have an impact on the severity of the traffic, we have conducted the exploratory data analysis listed below.

```{r include=FALSE }
clean_acc21 %>% 
      group_by(Amenity, Bump, Crossing, Give_Way, Junction, No_Exit, Railway, Roundabout, Station, Stop, Traffic_Calming, Traffic_Signal, Turning_Loop)%>%
    summarise(percentage = n()/nrow(clean_acc21) *100 )%>%
    arrange(-percentage) %>%
    filter(percentage > 1) -> accidents_per_roadelement

head(accidents_per_roadelement)
```

We sought to determine the number of accidents that neighboring road elements have contributed to in order to respond to our SMART question, "Does Nearby Road Elements Affect the Severity of Traffic?"

To comprehend this, we are taking into account the mishaps 1% or more of the total data that were caused by neighboring elements.
The data show that Junctions, Crossings, Traffic Signals, Stations, and Stop Boards were the biggest contributors to accidents.

```{r}
acc_road_element_per <- tibble(c("None", "Junction","Crossing", "Traffic signal", "Crossing and traffic signal", "Station", "Stop" ), pull(accidents_per_roadelement, percentage), .name_repair = ~ c("road_elements", "percentage"))
acc_road_element_per
       
```

The bar plot makes it clear that only 23% of accidents happened near any of the road elements taken into account, and junctions are the location of the most accidents (6.52%), while stop boards are the location of the fewest incidents (1.37%).

```{r fig.align="center", echo = FALSE,fig.width = 12}
options(repr.plot.width = 30, repr.plot.height = 8)
acc_road_element_per %>%
    ggplot() +
    geom_col(mapping = aes(x=reorder(road_elements, -percentage), y=percentage, fill = road_elements)) +
    
  labs(title="Accidents By Nearby road elements", x="Road Elements", y = "Percentage")+
  theme(plot.title = element_text(hjust = 0.5))

```


```{r include=FALSE}


accidents_per_roadelement<-clean_acc21 %>% 
      select(Is_severe,Junction,Crossing,Stop,Station,Traffic_Signal)


head(accidents_per_roadelement)

```


```{r include= FALSE}
Junction_data<- subset(accidents_per_roadelement, Junction=="True",
select=c(Is_severe,Junction))
head(Junction_data)

Crossing_data<- subset(accidents_per_roadelement, Crossing=="True",
select=c(Is_severe,Crossing))
head(Crossing_data)

Stop_data<- subset(accidents_per_roadelement, Stop=="True",
select=c(Is_severe,Stop))
head(Stop_data)

Station_data<- subset(accidents_per_roadelement, Station=="True",
select=c(Is_severe,Station))
head(Station_data)

Traffic_Signal_data<- subset(accidents_per_roadelement, Traffic_Signal=="True",
select=c(Is_severe,Traffic_Signal))
head(Traffic_Signal_data)
```

Let's now examine how these five nearby road elements impact how severe the traffic is.
Since it is a real-world dataset, it is obvious from the bar chart that only a small percentage of traffic accidents that are caused by nearby road elements are severe, compared to the majority of traffic accidents that are not severe.


```{r}


plot1<-ggplot(data=Junction_data, aes(x=Is_severe, y=Junction, fill=Is_severe)) +
  geom_bar(stat="identity")+
  labs(title="Accidents By Junction", x="Severity", y = "Junction")+
  theme(plot.title = element_text(hjust = 0.5))

plot2<-ggplot(data=Crossing_data, aes(x=Is_severe, y=Crossing, fill=Is_severe)) +
  geom_bar(stat="identity")+
  labs(title="Accidents By Crossing", x="Severity", y = "Crossing")+
  theme(plot.title = element_text(hjust = 0.5))

plot3<-ggplot(data=Stop_data, aes(x=Is_severe, y=Stop, fill=Is_severe)) +
  geom_bar(stat="identity")+
  labs(title="Accidents By Stop", x="Severity", y = "Stop")+
  theme(plot.title = element_text(hjust = 0.5))

plot4<-ggplot(data=Station_data, aes(x=Is_severe, y=Station, fill=Is_severe)) +
  geom_bar(stat="identity")+
  labs(title="Accidents By Station", x="Severity", y = "Station")+
  theme(plot.title = element_text(hjust = 0.5))

plot5<-ggplot(data=Traffic_Signal_data, aes(x=Is_severe, y=Traffic_Signal, fill=Is_severe)) +
  geom_bar(stat="identity")+
  labs(title="Accidents By Traffic Signal", x="Severity", y = "Traffic Sisgnal")+
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(plot1, plot2, plot3, plot4, plot5, ncol=2)
```



```{r include=FALSE}

accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(severe_num = if_else(Is_severe== "Severe", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Crossing_num = if_else(Crossing== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Stop_num = if_else(Stop== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Station_num = if_else(Station== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Traffic_Signal_num = if_else(Traffic_Signal== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Junction_num = if_else(Junction== "True", 1, 0))

```

Next, we perfom an ANOVA test for the differences in mean values between different Road elements.

H0 : The mean of Severity of traffic are the same across Nearby Road Elements( Junction,Crossing, Stop,Station, Traffic Signal).
H1 : The mean of Severity of traffic are the not the same across Nearby Road Elements( Junction,Crossing, Stop,Station, Traffic Signal).

Since the p-value is lower than 0.05, we need to reject the null hypothesis.

```{r include=FALSE}
Junction_anova = aov(Junction_num~severe_num, data=accidents_per_roadelement)
summary(Junction_anova)

Crossing_anova = aov(Crossing_num~severe_num, data=accidents_per_roadelement)
summary(Crossing_anova)

Stop_anova = aov(Stop_num~severe_num, data=accidents_per_roadelement)
summary(Stop_anova)

Station_anova = aov(Station_num~severe_num, data=accidents_per_roadelement)
summary(Station_anova)

Traffic_signal_anova = aov(Traffic_Signal_num~severe_num, data=accidents_per_roadelement)
summary(Traffic_signal_anova)
```



```{r}
test_Hour <- chisq.test(table(clean_acc21$Severity, clean_acc21$Hour))
test_Hour
```
Took a Chi-Squared test to see if the severity and Hour of day are independent.
We have performed Chi-Squared test because both variables are categorical.
H0 : Severity and Hour are independent
H1 : Severity and Hour are NOT independent
We can reject the H0. 
This means that there is a relationship between Severity and Hour.
```{r}
test_Month <- chisq.test(table(clean_acc21$Severity, clean_acc21$Month))
test_Month
```
Took a Chi-Squared test to see the severity and weather Months are independent.
We have performed Chi-Squared test because both variables are categorical.
H0 : Severity and Month are independent
H1 : Severity and Month are NOT independent
We can reject the H0. 
This means that there is a relationship between Severity and Hour.

Now let's check how strong these relationships are.
```{r}
cor(clean_acc21$Severity, clean_acc21$Month)
```
Correlation test performed to test strength of relationship between severity and Month.
The resulting value indicates that the relationship is weak.

```{r}
cor(clean_acc21$Severity, clean_acc21$Hour)
```
Correlation test performed to test strength of relationship between severity and Hour.
The resulting value indicates that the relationship is weak.

