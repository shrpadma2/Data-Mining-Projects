---
authors: 
title: "us_accidents_traffic"
output: html_document
date: "2022-10-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries Used}

```

```{r intro}
df_us_acc <- data.frame(read.csv('../us_accidents_dataset/US_Accidents_Dec21_updated.csv'))
str(df_us_acc)
```

```{r}
df_us_acc  %>%
  summarise_all(list(~is.na(.)))
```


```{r}
df_us_acc$year<-format(as.Date(df_us_acc$Start_Time, format="%Y-%m-%d"),"%Y")

```

```{r}
head(df_us_acc)

```


```{r}
library(ggplot2)
# Most basic bar chart
ggplot(df_us_acc, aes(x = year)) +
    geom_bar()

```


```{r}

accidents_2021 <- subset(df_us_acc, year==2021)
head(accidents_2021)
```
```{r}

accidents_2021$month<-format(as.Date(accidents_2021$Start_Time, format="%Y-%m-%d"),"%m")
head(df_us_acc)
```
```{r}
ggplot(accidents_2021, aes(x = month)) +
    geom_bar()

```

```{r}
accidents_2021  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```

```{r}

accidents_2021  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()

```
```{r}
clean_acc22 <- drop_na(accidents_2021)
str(clean_acc22)
clean_acc22  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```

```{r}
us_time<- accidents_2021$Start_Time
us_time_formatted<-hour(us_time)
hist(us_time_formatted)
```

```{r Correlations for numerical values}
# subsetting numerical columns only to check the corelationship between numerical variables
loadPkg("corrplot")
num_clean_acc22 <- select_if(clean_acc22, is.numeric)
str(num_clean_acc22)
cor_num_clean_acc22 <- cor(num_clean_acc22)
cor_num_clean_acc22
corrplot(cor_num_clean_acc22, method = "number")
```

```{r Histograms for Weather Conditions}

tempHist <- ggplot(clean_acc22, aes(x=Temperature.F.)) + geom_histogram(color="black", fill = "red")+
  ggtitle("Histogram of Temperature(F) for accidents")
tempHist

windcHist <- ggplot(clean_acc22, aes(x=Wind_Chill.F.)) + geom_histogram(color="black", fill = "orange")+
  ggtitle("Histogram of Wind chill for accidents")
windcHist

humidHist <- ggplot(clean_acc22, aes(x=Humidity...)) + geom_histogram(color="black", fill = "yellow")+
  ggtitle("Histogram of Humidity for accidents")
humidHist

windsHist <- ggplot(clean_acc22, aes(x=Wind_Speed.mph.)) + geom_histogram(color="black", fill = "navy")+
  ggtitle("Histogram of Wind Speed for accidents")
windsHist

pressHist <- ggplot(clean_acc22, aes(x=Pressure.in.)) + geom_histogram(color="black", fill = "green")+
  ggtitle("Histogram of Pressure for accidents")
pressHist

visibHist <- ggplot(clean_acc22, aes(x=Visibility.mi.)) + geom_histogram(color="black", fill = "blue")+
  ggtitle("Histogram of Visibility for accidents")
visibHist

precipHist <- ggplot(clean_acc22, aes(x=Precipitation.in.)) + geom_histogram(color="black", fill = "purple")+
  ggtitle("Histogram of Precipitation for accidents")
precipHist

## the first three histograms can be useful

```

```{r boxplots between Severity and wind conditions elements }
box_clean <- clean_acc22 
box_clean$Severity <- as.factor(box_clean$Severity) #set severity as factor to see the distributions of variables by severity levels

ggplot(box_clean, aes(x = Severity, y=Temperature.F.)) + 
  geom_boxplot() +
  labs(title="Temperature by Severity", x="Severity", y = "Temperature(F)")

ggplot(box_clean, aes(x = Severity, y=Wind_Chill.F.)) + 
  geom_boxplot() +
  labs(title="Wind Chill by Severity", x="Severity", y = "Wind Chill")

ggplot(box_clean, aes(x = Severity, y=Wind_Speed.mph.)) + 
  geom_boxplot() +
  labs(title="Wind Speed by Severity", x="Severity", y = "Wind Speed")

ggplot(box_clean, aes(x = Severity, y=Humidity...)) + 
  geom_boxplot() +
  labs(title="Humidity by Severity", x="Severity", y = "Humidity")

ggplot(box_clean, aes(x = Severity, y=Pressure.in.)) + 
  geom_boxplot() +
  labs(title="Pressure by Severity", x="Severity", y = "Pressure")

ggplot(box_clean, aes(x = Severity, y=Visibility.mi.)) + 
  geom_boxplot() +
  labs(title="Visibility by Severity", x="Severity", y = "Visibility")

ggplot(box_clean, aes(x = Severity, y=Precipitation.in.)) + 
  geom_boxplot() +
  labs(title="Precipitation by Severity", x="Severity", y = "Precipitation")

## The same variables(Temp, wind chill, humidity) have pretty plots

```

```{r ANOVA tests for weather condition elements}
# Do ANOVA test to those three variables
anovaTemp = aov(Temperature.F. ~ Severity, data=box_clean)
summary(anovaTemp)
print("----------------------------------------------------------")
anovaWindC = aov(Wind_Chill.F. ~ Severity, data=box_clean)
summary(anovaWindC)
print("----------------------------------------------------------")
anovaHumid = aov(Humidity... ~ Severity, data=box_clean)
summary(anovaHumid)
print("----------------------------------------------------------")
anovaPress = aov(Pressure.in. ~ Severity, data=box_clean)
summary(anovaPress)
print("----------------------------------------------------------")
anovaVisib = aov(Visibility.mi. ~ Severity, data=box_clean)
summary(anovaVisib)
print("----------------------------------------------------------")
anovaWindS = aov(Wind_Speed.mph. ~ Severity, data=box_clean)
summary(anovaWindS)
print("----------------------------------------------------------")
anovaPrecip = aov(Precipitation.in. ~ Severity, data=box_clean)
summary(anovaPrecip)
```
H0: The means of Temperature/WindChill/Humidity will be same among different Severity levels.
H1: The means of Temperature/WindChill/Humidity will NOT be same among different Severity levels.
The P-value for the all are lower than 0.05 for those all so we can reject the H0.
```{r Wind_Direction}
# wind direction with severity
ggplot(clean_acc22, aes(Wind_Direction, ..prop.., group = Severity)) +
  geom_bar(aes(fill = Severity)) +
  #scale_y_continuous(labels = percent) +
  labs(x = "Wind Direction",
       y = "Proportion",
       title = "Wind direction by Severity") +
  theme(text = element_text(size=8))
```
Wind Direction does not have much impact on the severity of accidents.

```{r Weather_Condition variables}
# Weather Condition percentage
unique(clean_acc22$Weather_Condition)
WC <- clean_acc22 %>%
  group_by(Weather_Condition) %>%
  summarise(cnt = n()) %>%
  mutate(freq = (round(cnt/sum(cnt), 3))*100 )%>%
  arrange(desc(freq)) %>%
  filter(freq > 1)
WC
WC %>%
    ggplot() +
    geom_col(mapping = aes(x=reorder(Weather_Condition, -freq), y=freq, fill = Weather_Condition)) +
    labs(x = "Weather Condition", y="%", title ="Top 8 Weather Conditions with accidents") +
    theme(text = element_text(size=7))
```
```{r}
# Try the Chi-Squared Test on all Weather_Conditions and Severity
WCtable <- table(clean_acc22$Weather_Condition , clean_acc22$Severity)
xkabledply(WCtable, title = "Severity by Weather Conditions")
chitest = chisq.test(WCtable)
chitest
```
Took a Chi-Squared test to see the severity and weather conditions are independent.
H0 : Severity and weather conditions are independent
H1 : Severity and weather conditions are NOT independent
We can reject the H0. 
